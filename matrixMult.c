#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <pthread.h>

#define MAX_THREAD 20
#define M 20

float A[M][M] = { {0.01, 0.07, 0.06, 0.08, 0.03, 0.06, 0.00, 0.07, 0.06, 0.03, 0.03, 0.10, 0.07, 0.05, 0.05, 0.08, 0.07, 0.01, 0.08, 0.02 },
                {0.11, 0.07, 0.06, 0.08, 0.10, 0.06, 0.10, 0.03, 0.03, 0.01, 0.05, 0.00, 0.04, 0.07, 0.03, 0.11, 0.07, 0.03, 0.02, 0.06 },
                {0.06, 0.08, 0.06, 0.01, 0.04, 0.02, 0.12, 0.01, 0.11, 0.04, 0.03, 0.09, 0.01, 0.01, 0.02, 0.02, 0.07, 0.09, 0.08, 0.07 },
                {0.03, 0.02, 0.02, 0.01, 0.00, 0.01, 0.05, 0.02, 0.09, 0.09, 0.04, 0.07, 0.06, 0.02, 0.03, 0.07, 0.00, 0.10, 0.01, 0.08 },
                {0.03, 0.01, 0.06, 0.05, 0.00, 0.04, 0.04, 0.04, 0.08, 0.07, 0.07, 0.10, 0.07, 0.02, 0.08, 0.04, 0.02, 0.03, 0.05, 0.02 },
                {0.07, 0.09, 0.06, 0.05, 0.01, 0.09, 0.09, 0.01, 0.07, 0.02, 0.07, 0.09, 0.08, 0.05, 0.05, 0.13, 0.08, 0.03, 0.03, 0.01 },
                {0.08, 0.05, 0.06, 0.08, 0.03, 0.04, 0.04, 0.08, 0.02, 0.08, 0.01, 0.03, 0.03, 0.04, 0.04, 0.01, 0.01, 0.00, 0.05, 0.06 },
                {0.07, 0.01, 0.05, 0.05, 0.09, 0.03, 0.03, 0.08, 0.02, 0.03, 0.07, 0.03, 0.01, 0.09, 0.06, 0.10, 0.10, 0.09, 0.07, 0.03 },
                {0.00, 0.07, 0.07, 0.07, 0.09, 0.02, 0.06, 0.01, 0.06, 0.09, 0.06, 0.00, 0.06, 0.06, 0.01, 0.04, 0.05, 0.04, 0.04, 0.09 },
                {0.01, 0.09, 0.07, 0.02, 0.04, 0.07, 0.02, 0.06, 0.03, 0.05, 0.06, 0.10, 0.09, 0.10, 0.00, 0.01, 0.05, 0.09, 0.04, 0.02 },
                {0.03, 0.01, 0.07, 0.01, 0.09, 0.05, 0.01, 0.06, 0.08, 0.02, 0.04, 0.08, 0.08, 0.01, 0.00, 0.03, 0.00, 0.02, 0.03, 0.02 },
                {0.01, 0.00, 0.03, 0.01, 0.06, 0.10, 0.02, 0.06, 0.08, 0.03, 0.07, 0.05, 0.02, 0.06, 0.10, 0.02, 0.09, 0.04, 0.00, 0.01 },
                {0.05, 0.02, 0.06, 0.10, 0.01, 0.07, 0.06, 0.06, 0.01, 0.08, 0.06, 0.02, 0.06, 0.09, 0.08, 0.06, 0.01, 0.04, 0.06, 0.03 },
                {0.06, 0.04, 0.01, 0.04, 0.09, 0.03, 0.07, 0.08, 0.08, 0.05, 0.03, 0.11, 0.04, 0.03, 0.06, 0.08, 0.03, 0.03, 0.08, 0.09 },
                {0.09, 0.06, 0.01, 0.01, 0.05, 0.01, 0.07, 0.04, 0.02, 0.03, 0.06, 0.01, 0.02, 0.05, 0.06, 0.02, 0.00, 0.07, 0.08, 0.06 },
                {0.08, 0.01, 0.06, 0.08, 0.03, 0.06, 0.04, 0.02, 0.00, 0.04, 0.07, 0.04, 0.02, 0.05, 0.09, 0.02, 0.09, 0.08, 0.10, 0.05 },
                {0.05, 0.09, 0.05, 0.10, 0.08, 0.01, 0.01, 0.05, 0.02, 0.06, 0.06, 0.00, 0.06, 0.10, 0.01, 0.03, 0.09, 0.04, 0.02, 0.10 },
                {0.02, 0.04, 0.06, 0.04, 0.03, 0.07, 0.02, 0.07, 0.03, 0.09, 0.07, 0.03, 0.04, 0.09, 0.05, 0.04, 0.03, 0.09, 0.08, 0.06 },
                {0.08, 0.09, 0.03, 0.06, 0.06, 0.09, 0.06, 0.06, 0.06, 0.04, 0.04, 0.03, 0.02, 0.01, 0.07, 0.07, 0.10, 0.09, 0.02, 0.03 },
                {0.07, 0.08, 0.04, 0.03, 0.06, 0.08, 0.11, 0.08, 0.06, 0.04, 0.00, 0.01, 0.09, 0.00, 0.08, 0.03, 0.04, 0.01, 0.08, 0.10 } };


float B[M][M] = { {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 },
                {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 } };


float C[M][M];
int step=0;


void* multiply(void* arg)
{
    int core = step++;

    for (int i = core * M / MAX_THREAD; i < (core + 1) * M / MAX_THREAD; i++)
        for (int j = 0; j < M; j++)
            for (int k = 0; k < M; k++)
                C[i][j] += A[i][k] * B[k][j];
}
int main()
{
    FILE *outfile;

    outfile = fopen("out.txt", "w");
    //pthread for 400 threads
    pthread_t threads[MAX_THREAD];

    for (int i = 0; i < M; i++){
      for (int j = 0; j < M; j++){
        C[i][j] = 0;
      }
    }


    //creating threads to multiply individual elements
    for(int i=0;i < MAX_THREAD;i++)
    {
      int* p;
      if (pthread_create(&threads[i], NULL, multiply, (void*)(p))){
        perror("Thread Error");
    		exit(-1);
      }
    }

    //Joining threads together after multiplication has been performed
    for(int i=0; i < MAX_THREAD; i++)
    {
        pthread_join(threads[i],NULL);
    }

   //OUTPUT
     for (int i = 0; i < M; i++)
     {
        for (int j = 0; j < M; j++)
        {
            fprintf(outfile,"%f ", C[i][j]);
        }
        fprintf(outfile,"\n");
    }

    fclose(outfile);

    return 0;
}
